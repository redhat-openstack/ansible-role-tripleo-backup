---
- name: check or install required packages
  yum: name={{ item }} state=latest
  with_items:
    - libvirt
    - qemu-kvm
    - net-tools

- name: make sure libvirtd is started
  service: name=libvirtd state=started

- name: remove tripleo vms working dir
  file:
    path: "{{ oooq_vms_path }}"
    state: absent
  become: true

# @TODO matbu: make a teardown set of tasks and tags
- name: destroy vms
  ignore_errors: true
  with_items: "{{ vms }}"
  shell: >
    virsh destroy {{ item }};
    virsh undefine {{ item }};

- name: destroy network if exist
  ignore_errors: true
  with_items: "{{ networks_name }}"
  shell: >
    if virsh net-list | grep {{ item }}; then
        virsh net-destroy {{ item }};
        virsh net-undefine {{ item }}
    fi

- name: destroy pool
  ignore_errors: true
  shell: >
    virsh pool-destroy {{ pool_name }}

- name: create tripleo vms working dir
  file:
    path: "{{ oooq_tar_path }}"
    state: directory
  become: true

- name: download tar file
  register: download
  get_url:
    url: "{{ proto }}://{{ http_server }}/{{ http_path }}/{{ oooq_tar_name }}"
    dest: "{{ oooq_tar_path }}"

- name: test if oooq tmp tar dir is present
  register: test_dir
  shell: >
    test -d /tmp/var/oooqvms

- name: untar tripleo vms
  when: download.changed|bool and test_dir.rc == 0
  unarchive:
    src: "{{ oooq_tar_path }}/{{ oooq_tar_name }}"
    dest: "/tmp"
    copy: no
# @TODO: matbu test out this rather than fetch and untar
#    src: "{{ proto }}://{{ http_server }}/{{ http_path }}/{{ oooq_tar_name }}"

- name: move oooq file
  shell: >
    mv /tmp/var/oooqvms {{ oooq_vms_path }}

- name: create oooq_pool
  shell: >
    virsh pool-create {{ oooq_vms_path }}/{{ pool_name }}.xml

- name: create networks
  shell: >
    virsh net-create {{ oooq_vms_path }}/{{ item }}.xml
  with_items: "{{ networks_name }}"

- name: start vms
  shell: >
    virsh create {{ oooq_vms_path }}/{{ item }}.xml
  with_items: "{{ vms }}"
